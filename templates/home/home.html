{% extends 'base.html'%}
{% load static %}
{% load leaflet_tags %}
{% load bootstrap5 %}

{% bootstrap_css %}
{% bootstrap_javascript %}




{% block map_content %}
<style>
    .leaflet-container {

        width: 100%;
        height: 100%;
    }

    #specialbigmap {
        height: 600px;
    }

    /* Resize the "display_raw" textbox */
    .django-leaflet-raw-textarea {
        width: 100%;
    }

    .leaflet-marker-icon img {
        border: 0;
    }

    #map {
        height: 100%;
        width: 100%;
    }

    #slides {
        min-height: 50px;
    }
</style>

<!-- stylesheets -->
{% leaflet_js %}
{% leaflet_css %}

<link href="{% static 'fontawesomefree/css/all.min.css' %}" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
{% if user.is_superuser %}
<div class="col">
    <div class="card">
        <div class="card-body">

            <fieldset name="Multiple Files Upload">
                <div class="row">
                    <div class="col">
                        {% csrf_token %}
                        <input class="form-control form-control" type="file" id="excel" name="file" />
                    </div>
                    <div class="col">
                        <button class="btn btn-primary" type="submit" id="upload">Upload</button>
                    </div>
                </div>

            </fieldset>
        </div>
    </div>
</div>
{% endif %}
{% leaflet_map "main" %}

<div id="sidebar" class="leaflet-sidebar">
    <!-- nav tabs -->
    <div class="leaflet-sidebar-tabs">
        <!-- top aligned tabs -->
        <ul role="tablist">
            <li><a href="#home" role="tab"><i class="fa fa-home active"></i></a></li>
            <li><a href="#autopan" role="tab"><i class="fa fa-book-open"></i></a></li>
            <li><a href="/admin" role="tab"><i class="fa fa-key"></i></a></li>
        </ul>


    </div>

    <!-- panel content -->
    <div class="leaflet-sidebar-content">
        <div class="leaflet-sidebar-pane" id="home">
            <h1 class="leaflet-sidebar-header">
                Home
                <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
            </h1>

            <div>
                <h4>Northern Uganda Tourist Sites</h4>
            </div>
            <br>
            <div class="description">
                <p>This webmap shows the different tourists sites and nearby amenities. For further information of each
                    amenity and tourist site click the icon.</p>
            </div>
            <div>
                <img src="https://live.staticflickr.com/65535/52215778688_96ca5c21ea.jpg" width="100%" class="img-fluid"
                    alt="">
            </div>
            <br>
            <div>
                <p>Learn more about the Pearl of Africa, Uganda's tourist sites in northern Uganda with a brief history
                    and images to
                    provide digital insight and experience.

                    Contact the numbers displayed for further information and support.</p>
            </div>
            <div>
                <h5>Restaurants</h5>
                <p>Experience Uganda's Local Foods with a touch of the Northern Cuisine spanning from different staple
                    foods of
                    the region.</p>
                <br>
                <h5>Hangouts</h5>
                <p>A place to cool off a good day with a cold Nile Special Beer among other drinks with smooth
                    music with a touch
                    of africa's afro beat and nice melodic music</p>

            </div>
            <div>
                <h5>Banks</h5>
                <img src="https://www.kampalapost.com/sites/default/files/2020-10/Stanbic%20Bank%20has%20been%20hit%20by%20another%20fraud%20scandal.jpeg"
                    class="img-fluid" width="100%" alt="">
                <br>
                <p>Out of Cash?, worry not as here are the Financial services available to support you on your
                    exploration journey. A few
                    places accept VISA / MasterCard payments</p>
            </div>
            <div>
                <h5>Accomodation</h5>
                <p>Amazing accommodation for all walks of life and budget as you experience nature in the northern Pearl
                    of Africa, Uganda.
                </p>
                <img src="https://live.staticflickr.com/65535/52216045214_3ec431d94e.jpg" width="100%" alt="">
            </div>
        </div>

        <div class="leaflet-sidebar-pane" id="autopan">

        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>




    <script>
        var dataurl = '{% url "get_sites" %}';
        var chilldataurl = '{% url "get_chills" %}';
        // var data = new L.GeoJSON.AJAX(dataurl)
        var sidebarDiv = document.getElementById('sidebar');
        var selected;

        var siteMarker = L.ExtraMarkers.icon({
            icon: 'fa-monument',
            markerColor: 'green',
            shape: 'square',
            prefix: 'fa'
        })

        var restaurantMarker = L.ExtraMarkers.icon({
            icon: 'fa-coffee',
            markerColor: 'orange',
            shape: 'square',
            prefix: 'fa'
        })

        function get_marker(color, icon) {
            return L.ExtraMarkers.icon({
                icon: icon,
                markerColor: color,
                shape: 'square',
                prefix: 'fa'
            })
        }

        window.addEventListener("map:init", function (event) {
            var map = event.detail.map;
            var sidebar = L.control.sidebar('sidebar', {
                autopan: false,
                container: 'sidebar',
                closeButton: true,
                position: 'right'
            }).addTo(map).open('home');

            L.control.locate({
                flyTo: true
            }).addTo(map);

            sidebar.on('content', function (ev) {
                switch (ev.id) {
                    case 'autopan':
                        sidebar.options.autopan = true;
                        break;
                    default:
                        sidebar.options.autopan = false;
                }
            });

            function createButton(label, container) {
                var btn = L.DomUtil.create('button', '', container);
                btn.setAttribute('type', 'button');
                btn.innerHTML = label;
                return btn;
            }

            // map.on('click', function (e) {
            //     var container = L.DomUtil.create('div'),
            //         startBtn = createButton('Start from this location', container),
            //         destBtn = createButton('Go to this location', container);

            //     L.popup()
            //         .setContent(container)
            //         .setLatLng(e.latlng)
            //         .openOn(map);
            // });







            // var markers = L.markerClusterGroup();
            // Download GeoJSON data with Ajax
            // map.addControl(sidebar);

            fetch(dataurl)
                .then(function (resp) {
                    return resp.json();
                })
                .then(function (data) {
                    points = L.geoJson(data)
                    L.geoJson(data, {
                        onEachFeature: function onEachFeature(feature, layer) {

                            var container = L.DomUtil.create('div'),
                                startBtn = createButton('Start from this location', container),
                                destBtn = createButton('Go to this location', container);

                            var popup = L.popup()
                                .setLatLng([51.513, -0.09])
                                .setContent(container)
                                .openOn(map);



                            var props = feature.properties;
                            var content = `<h3>${props.location_code}</h3><p>${props.location_code}</p>`;
                            layer.setIcon(siteMarker);
                            // layer.bindPopup(popup);
                            layer.on({
                                click: function () {
                                    // console.log(feature.latlng);
                                    // L.DomEvent.on(startBtn, 'click', function () {
                                    //     L.control.spliceWaypoints(0, 1, feature.geometry.coordinates);
                                    //     map.closePopup();
                                    // });

                                    // L.DomEvent.on(destBtn, 'click', function () {
                                    //     L.control.spliceWaypoints(L.control.getWaypoints().length - 1, 1, feature.geometry.coordinates);
                                    //     map.closePopup();
                                    // });

                                    console.log(props)
                                    content = document.getElementById('autopan').innerHTML = `
                                                                <h1 id="name" class="leaflet-sidebar-header">
                                                                   ${props.name}
                                                                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                                                                </h1>
                                                                <div>
                                                                    <div id="slides" data-bs-ride="carousel"></div>
                                                                <div>
                                                                <div>
                                                                    <h6>Year started:</h6>
                                                                    <p id="year_started">${props.year_of_inception}</p>
                                                                </div>
                                                                <div>
                                                                    <h6>Description: </h6>
                                                                    <p id="description">${props.description}</p>
                                                                </div>
                                                                <div>
                                                                    <h6>Fee: </h6>
                                                                    <p id="fee">${props.fee}</p>
                                                                </div>
                                                                <div>
                                                                    <h6>Contact: </h6>
                                                                    <p id="contact">${props.contact_name}</p>
                                                                </div>
                                                                <div>
                                                                    <h6>Phone: </h6>
                                                                    <p id="phone">${props.conatct}</p>
                                                                </div>
                                                                <div>
                                                                    <h6>Email: </h6>
                                                                    <p id="email">${props.email ? props.email : 'Not provided'}</p>
                                                                </div>
                                                                <div>
                                                                    <h6>Access Road: </h6>
                                                                    <p id="access_road"></p>
                                                                </div>
                                                            `;

                                    var myCarousel = document.querySelector('#slides')
                                    // for (let x in props.media) {
                                    console.log(props.media[x])
                                    img = props.media[0].link ? `<div><img src=${props.media[0].link}></div>` : ""
                                    myCarousel.innerHTML += img
                                    // }

                                    var carousel = new bootstrap.Carousel(myCarousel)

                                }
                            })

                        }
                    }).addTo(map)
                    map.fitBounds(points.getBounds());


                });


            fetch(chilldataurl)
                .then(function (resp) {
                    return resp.json();
                })
                .then(function (data) {
                    console.log(data);
                    points = L.geoJson(data)
                    L.geoJson(data, {
                        onEachFeature: function onEachFeature(feature, layer) {

                            var container = L.DomUtil.create('div'),
                                startBtn = createButton('Start from this location', container),
                                destBtn = createButton('Go to this location', container);

                            var popup = L.popup()
                                .setLatLng([51.513, -0.09])
                                .setContent(container)
                                .openOn(map);



                            var props = feature.properties;
                            var content = `<h3>${props.location_code}</h3><p>${props.location_code}</p>`;
                            layer.setIcon(restaurantMarker);
                            layer.setIcon(get_marker(props.type.color, props.type.incon))
                            // layer.bindPopup(popup);
                            layer.on({
                                click: function () {
                                    // console.log(feature.latlng);
                                    // L.DomEvent.on(startBtn, 'click', function () {
                                    //     L.control.spliceWaypoints(0, 1, feature.geometry.coordinates);
                                    //     map.closePopup();
                                    // });

                                    // L.DomEvent.on(destBtn, 'click', function () {
                                    //     L.control.spliceWaypoints(L.control.getWaypoints().length - 1, 1, feature.geometry.coordinates);
                                    //     map.closePopup();
                                    // });

                                    // console.log(props)
                                    content = document.getElementById('autopan').innerHTML = `
                                                             
                                                            
                                                               
                                                                <h1 id="name" class="leaflet-sidebar-header">
                                                                   ${props.name}
                                                                    <span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span>
                                                                </h1>
                                                               <div>
                                                                    <div id="slides" data-bs-ride="carousel"></div>
                                                                <div>
                                                                <div class="info">
                                                                    <div>
                                                                        <h3 class="title">${props.name}</h3>
                                                                    </div>
                                                                    
                                                                    <div class="contact">
                                                                        <h5>Contact</h5>
                                                                        <p>${props.contact}</p>

                                                                        <div>
                                                                            <h5>Email</h5>
                                                                            <p>${props.email}</p>
                                                                        </div>
                                                                    </div>
                                                                    <div>
                                                                        <h5>Website</h5>
                                                                        <p>${props.website}</p>
                                                                    </div>
                                                                    <div>
                                                                        <h5>Total rooms</h5>
                                                                        <p>${props.number_of_rooms}</p>
                                                                    </div>
                                                                    <div>
                                                                        <h5>Fees Per Night (Bed and Breakfast)</h5>
                                                                        <p>${props.fee}</p>
                                                                    </div>
                                                                </div>
                                                            
                                                            `;

                                    var myCarousel = document.querySelector('#slides')
                                    // for (let x in props.media) {
                                    console.log(props.media[0])
                                    img = props.media[0].link ? `<div><img src=${props.media[0].link}></div>` : ""
                                    myCarousel.innerHTML += img
                                    // }

                                    var carousel = new bootstrap.Carousel(myCarousel)

                                }
                            })

                        }
                    }).addTo(map)
                    map.fitBounds(points.getBounds());


                });
        });

        $(document).ready(function (e) {
            $('#upload').on('click', function () {
                var form_data = new FormData();
                var ins = document.getElementById('excel').files.length;

                if (ins == 0) {
                    $('#msg').html('<span style="color:red">Select at least one file</span>');
                    return;
                }

                for (var x = 0; x < ins; x++) {
                    form_data.append("file", document.getElementById('excel').files[x]);
                }

                csrf_token = $('input[name="csrfmiddlewaretoken"]').val();

                //console.log(csrf_token);

                form_data.append("csrfmiddlewaretoken", csrf_token);

                $.ajax({
                    url: "{% url 'upload_file' %}", // point to server-side URL
                    dataType: 'json', // what to expect back from server
                    cache: false,
                    contentType: false,
                    processData: false,
                    //data: {'data': form_data, 'csrfmiddlewaretoken': csrf_token},
                    data: form_data,
                    type: 'post',
                    success: function (response) { // display success response
                        $('#msg').html(response.msg);
                    },
                    error: function (response) {
                        $('#msg').html(response.message); // display error response
                    }
                });
            });
        });
    </script>

    {% endblock map_content %}